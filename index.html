<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Label Generator for ASN in Paperless-ngx</title>
    <link
      rel="canonical"
      href="https://tobiasmaier.info/asn-qr-code-label-generator/"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <!-- bwip-js for DataMatrix generation in the browser -->
    <script src="https://unpkg.com/bwip-js/dist/bwip-js-min.js"></script>
    <style>
      @media print {
        /* See https://caniuse.com/css-paged-media */
        @page {
          /* Remove default margin set by the browser */
          margin: 0mm;
          size: A4;
        }
      }
    </style>
  </head>
  <body class="print:p-0" x-data="qrCodeApp()" x-init="init()">
    <div class="container mx-auto print:hidden">
      <h1 class="mb-4 text-xl font-bold print:hidden">
        Data Matrix Label Generator for
        <abbr title="Archive Serial Number">ASN</abbr> in Paperless-ngx
      </h1>
      <div class="prose prose-a:text-blue-600 prose-a:underline hover:prose-a:text-blue-700 mb-4 print:hidden">
        <p>
          This tool generates Data Matrix labels for the
          <a href="https://docs.paperless-ngx.com/advanced_usage/#archive-serial-number-assignment">Archive Serial Number (ASN)</a>
          feature in <a href="https://docs.paperless-ngx.com/">Paperless-ngx</a>.
        </p>

        <p>
          The <abbr title="Archive Serial Number">ASN</abbr> feature allows you
          to assign a unique serial number to each document in your archive.
          This is useful if you want to refer to a document in a paperless
          workflow. For example, you can print the ASN label and then use it to search for the document in Paperless-ngx.
        </p>

        <p>
          This tool generates Data Matrix labels. The labels produced are sized to the exact label size (25mm x 13mm) and pages are prepared for direct use with a label printer.
        </p>

        <p>
          To use this tool, enter the three-digit namespace and three-digit document start number. Choose the namespace background (black or white). The Data Matrix payload will always include the prefix "ASN" but it is not printed as text on the label. Click "Regenerate Labels" then "Print Labels".
        </p>

        <p>
          One <strong>known limitation of this tool</strong> is that it
          <strong>only works on Google Chrome and possibly Firefox</strong>.
          This is because it uses the
          <a href="https://caniuse.com/css-paged-media"><code>@page</code></a>
          CSS rule to control the page size, margin, and to turn off the default
          header and footer of the browser.
        </p>
      </div>
      <form @submit.prevent="generateLabels()" class="mb-8 print:hidden">
        <!-- User Input Fields -->
        <div class="mb-5 grid grid-cols-1 gap-5 md:grid-cols-3">
          <div>
            <label for="namespace" class="mb-2 block text-sm font-medium text-gray-900">Namespace (3 digits)</label>
            <input
              type="text"
              id="namespace"
              x-model="namespace"
              required
              maxlength="3"
              minlength="3"
              pattern="\\d{3}"
              value="001"
              class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label for="docStart" class="mb-2 block text-sm font-medium text-gray-900">Document Start (3 digits)</label>
            <input
              type="text"
              id="docStart"
              x-model="docStart"
              required
              maxlength="3"
              minlength="3"
              pattern="\\d{3}"
              value="001"
              class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label for="count" class="mb-2 block text-sm font-medium text-gray-900">Anzahl Etiketten</label>
            <input
              type="number"
              id="count"
              x-model="count"
              required
              min="1"
              max="1000"
              value="10"
              class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div class="md:col-span-1">
            <label class="mb-2 block text-sm font-medium text-gray-900">Namespace Hintergrund</label>
            <div class="flex items-center gap-4">
              <label class="inline-flex items-center"><input type="radio" name="nsBg" value="black" x-model="nsBg" class="mr-2"> Schwarz</label>
              <label class="inline-flex items-center"><input type="radio" name="nsBg" value="white" x-model="nsBg" class="mr-2"> Weiß</label>
            </div>
            <p class="prose prose-sm mt-1">Wenn weiß gewählt, kein Rahmen um das Etikett.</p>
          </div>
          <div class="md:col-span-2">
            <div class="flex items-start">
              <div class="flex h-5 items-center">
                <input
                  type="checkbox"
                  id="printPrefix"
                  x-model="printPrefix"
                  class="focus:ring-3 h-4 w-4 rounded border border-gray-300 bg-gray-50 focus:ring-blue-300"
                />
              </div>
              <label for="printPrefix" class="ms-2 text-sm font-medium text-gray-900">Print Document Number</label>
            </div>
            <p class="prose prose-sm mt-1">Gibt an, ob die Dokumentennummer als Text auf dem Etikett erscheinen soll. Das Präfix "ASN" wird nie als Text gedruckt, ist aber im DataMatrix-Code enthalten.</p>
          </div>
        </div>
        <div class="flex gap-3">
          <button
            @click.prevent="generateLabels()"
            class="rounded-lg bg-blue-700 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-300"
          >
            Regenerate Labels
          </button>
          <button
            @click.prevent="printLabels()"
            class="rounded-lg bg-green-700 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-green-800 focus:outline-none focus:ring-4 focus:ring-green-300"
          >
            Print Labels
          </button>
        </div>
      </form>
    </div>

    <style>
      /* Label size: 13mm x 25mm (hochkant / portrait) */
      .label-page {
        width: 13mm;
        height: 25mm;
        page-break-after: always;
        box-sizing: border-box;
      }
      .number {
        padding-top: 0.2mm;
        box-sizing: border-box;
        font-family: monospace, ui-monospace, SFMono-Regular;
        font-size: 4mm;
        text-align: center;
        color: #000;
      }
      .ns-dark {
        color: #ffffff;
        background-color: #000000;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      /* Encourage browsers to actually print background colors */
      .label-page, .number {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }


      @media print {
        @page {
          margin: 0;
          size: 13mm 25mm; /* width height in mm (portrait) */
        }
        body, html {
          margin: 0;
          padding: 0;
        }
        /* Make sure background stays black when printing */
        .ns-dark {
          background-color: #000000 !important;
          color: #ffffff !important;
        }
      }
    </style>

    <div id="labels-container" class="mx-auto">
      <template x-for="label in labels" :key="label.id">
        <div class="label-page">
          <!-- Content area: DataMatrix centered and below it a full-width monospace block with Namespace and DocNum -->
          <div class="flex flex-col items-center justify-center px-[0.8mm] py-[0.8mm] h-[calc(100% - 6mm)]">
            <canvas :data-canvas-id="label.id" class="block" width="300" height="300" style="width:9mm;height:9mm;margin-bottom:1.2mm;"></canvas>
            <div class="w-full text-center">
              <div class="number w-full" x-text="label.namespace"></div>
              <div class="number w-full" x-text="label.docNum"></div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <footer class="mt-8 bg-gray-200 py-4 text-center print:hidden">
      <p>
        &copy; 2023
        <a
          href="https://tobiasmaier.info"
          class="text-blue-600 underline hover:text-blue-700"
          >Tobias L. Maier</a
        >. All rights reserved. Licensed under the
        <a
          href="https://www.gnu.org/licenses/agpl-3.0.html"
          title="GNU Affero General Public License"
          class="text-blue-600 underline hover:text-blue-700"
          >AGPL v3.0</a
        >.
        <a
          href="https://github.com/tmaier/asn-qr-code-label-generator"
          class="text-blue-600 underline hover:text-blue-700"
          >Contribute via GitHub</a
        >
      </p>
    </footer>

    <script>
      function qrCodeApp() {
        return {
          namespace: '001',
          docStart: '001',
          count: 10,
          nsBg: 'black',
          printPrefix: true,
          labels: [],

          generateLabels() {
            // Validate inputs
            if (!/^\d{3}$/.test(this.namespace)) {
              alert('Namespace muss 3 Ziffern enthalten (z.B. 001)');
              return;
            }
            if (!/^\d{3}$/.test(this.docStart)) {
              alert('Document Start muss 3 Ziffern enthalten (z.B. 001)');
              return;
            }

            const ns = this.namespace;
            const start = parseInt(this.docStart, 10);
            const total = parseInt(this.count, 10) || 0;
            this.labels = [];

            for (let i = 0; i < total; i++) {
              const docNum = (start + i).toString().padStart(3, '0');
              const payload = `ASN${ns}${docNum}`; // DataMatrix payload contains ASN prefix
              const docNumDisplay = this.printPrefix ? `${docNum}` : '';
              const id = `lbl-${Date.now()}-${i}`;

              // Determine wrapper style depending on namespace background
              // Namespace band that spans the entire label width
              // Styles: fixed monospace font and sizes. Namespace gets background, doc number not.
              this.labels.push({ id, payload, docNum: docNumDisplay, namespace: ns });
            }

            // After DOM update, render DataMatrix on each canvas
            this.$nextTick(() => {
              if (typeof bwipjs === 'undefined' || !bwipjs.toCanvas) {
                alert('bwip-js konnte nicht geladen werden. DataMatrix Generierung wird nicht funktionieren.');
                return;
              }

              this.labels.forEach((label) => {
                const selector = `[data-canvas-id="${label.id}"]`;
                const canvas = document.querySelector(selector);
                if (!canvas) return;

                // Ensure the canvas is visually the right size
                canvas.style.width = '9mm';
                canvas.style.height = '9mm';

                try {
                  // Render DataMatrix using bwip-js
                  bwipjs.toCanvas(canvas, {
                    bcid: 'datamatrix',
                    text: label.payload,
                    scale: 4,
                    padding: 0,
                    includetext: false,
                  });
                } catch (err) {
                  console.error('bwipjs render error', err);
                }

                // Apply styles for namespace and doc number (fixed sizes)
                const nsElQuery = document.querySelector(`[data-canvas-id="${label.id}"]`);
                // find corresponding text block elements by traversing DOM: canvas -> parent -> text container
                const canvasEl = document.querySelector(selector);
                if (canvasEl) {
                  const textContainer = canvasEl.parentElement.parentElement.querySelector('.w-full');
                  if (textContainer) {
                    const nsEl = textContainer.querySelector(':scope > div:nth-child(1)');
                    if (this.nsBg === 'black') {
                      nsEl.classList.add('ns-dark');
                    } else {
                      nsEl.classList.remove('ns-dark');
                    }

                  }
                }
              });
            });
          },

          printLabels() {
            window.print();
          },

          init() {
            this.generateLabels();
          },
        };
      }
    </script>
  </body>
</html>
